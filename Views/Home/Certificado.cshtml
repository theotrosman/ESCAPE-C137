@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Certificado de Realidad Superada</title>
        <link rel="icon" type="image/png" href="~/img/morty-icon.png" />

    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #000;
            color: #00ff00;
            font-family: 'Fira Code', monospace;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        .matrix-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 0;
            pointer-events: none;
        }
        .scanlines {
            pointer-events: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 1;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0px, transparent 2px,
                rgba(0,255,0,0.08) 2px, rgba(0,255,0,0.08) 4px
            );
            mix-blend-mode: lighten;
            opacity: 0.18;
            animation: scanmove 2.5s linear infinite;
        }
        @@keyframes scanmove {
            0% { background-position-y: 0; }
            100% { background-position-y: 40px; }
        }
        #overlayIntro {
            position: fixed;
            width: 100vw;
            height: 100vh;
            background: #000;
            color: #00ff00;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
            font-family: 'Orbitron', monospace;
            text-align: center;
            animation: introAnim 2s ease-in-out;
            border: 3px solid #00ff00;
            box-shadow: 0 0 40px #00ff00cc;
        }
        @@keyframes introAnim {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        #certificado {
            width: 1100px;
            min-height: 700px;
            background: rgba(0,0,0,0.92);
            border-radius: 18px;
            margin: 3rem auto 2rem auto;
            box-shadow: 0 0 60px #00ff0033, 0 0 120px #0ff2;
            border: 2.5px solid #00ff00;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            position: relative;
            z-index: 10;
            overflow: hidden;
            padding: 2.5rem 3.5rem 2rem 3.5rem;
            animation: printAnim 1.2s steps(40, end);
        }
        @@keyframes printAnim {
            0% { filter: blur(8px) brightness(0.5); opacity: 0; }
            100% { filter: blur(0) brightness(1); opacity: 1; }
        }
        .header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .header h1 {
            font-family: 'Orbitron', monospace;
            font-size: 2.7rem;
            color: #00ff00;
            margin: 0;
            letter-spacing: 2px;
            text-shadow: 0 0 18px #00ff00, 0 0 32px #0ff;
        }
        .header .subtitulo {
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
            color: #0ff;
            margin: 0.7rem 0 0.2rem 0;
            font-style: italic;
            text-shadow: 0 0 8px #0ff;
        }
        .header .date-field {
            color: #fff;
            font-size: 1rem;
            margin-top: 0.2rem;
            opacity: 0.7;
        }
        .header .info-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(0,255,0,0.1);
            border: 1px solid #00ff00;
            border-radius: 5px;
            text-align: center;
        }
        .main-content {
            display: flex;
            flex-direction: row;
            gap: 2.5rem;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        .avatar-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 180px;
            max-width: 220px;
            margin-top: 0.5rem;
        }
        #fotoPreview {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border: 4px solid #00ff00;
            border-radius: 50%;
            box-shadow: 0 0 20px #00ff00, 0 0 40px #0ff;
            margin-bottom: 1rem;
            background: #111;
            transition: box-shadow 0.3s;
        }
        #fotoPreview:hover {
            box-shadow: 0 0 40px #f0f, 0 0 80px #0ff;
        }
        .photo-btn {
            background: linear-gradient(90deg, #00ff00 0%, #0ff 100%);
            color: #000;
            border: none;
            padding: 0.7rem 1.5rem;
            font-family: 'Orbitron', monospace;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 18px #00ff00;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .photo-btn:hover {
            background: linear-gradient(90deg, #0ff 0%, #00ff00 100%);
            color: #fff;
            box-shadow: 0 0 40px #0ff, 0 0 80px #f0f;
        }
        .avatar-tooltip {
            font-size: 0.95rem;
            color: #fff;
            background: #222d;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            margin-top: 0.2rem;
            box-shadow: 0 0 8px #0ff;
            display: none;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
        }
        .avatar-block:hover .avatar-tooltip {
            display: block;
        }
        .qr-block {
            margin-top: 1.2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #qr-canvas {
            margin-top: 0.2rem;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 8px #0ff;
        }
        .data-block {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.1rem;
        }
        .data-row {
            display: flex;
            gap: 1.2rem;
        }
        .info-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        .info-group label {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: #0ff;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 8px #0ff;
        }
        .info-group input, .info-group select, .info-group textarea {
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
            background: rgba(0,0,0,0.7);
            border: 2px solid #00ff00;
            color: #fff;
            padding: 0.7rem;
            border-radius: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px #00ff00cc;
        }
        .info-group input:focus, .info-group select:focus, .info-group textarea:focus {
            outline: none;
            border-color: #0ff;
            box-shadow: 0 0 20px #0ff;
            background: rgba(0,0,0,0.9);
        }
        .info-group textarea {
            resize: none;
            height: 60px;
        }
        .calificacion-block {
            margin: 2.2rem 0 1.2rem 0;
            text-align: center;
        }
        .calificacion-label {
            color: #0ff;
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
            font-family: 'Orbitron', monospace;
        }
        .grade-display {
            font-family: 'Orbitron', monospace;
            font-size: 2.7rem;
            color: #00ff00;
            font-weight: 700;
            text-shadow: 0 0 20px #00ff00, 0 0 40px #0ff;
            animation: gradeGlow 1s infinite alternate;
            display: inline-block;
            position: relative;
        }
        @@keyframes gradeGlow {
            0% { text-shadow: 0 0 20px #00ff00, 0 0 40px #0ff; }
            100% { text-shadow: 0 0 30px #00ff00, 0 0 50px #0ff, 0 0 70px #f0f; }
        }
        .rick-approved {
            display: none;
            position: absolute;
            top: -30px;
            right: -70px;
            width: 90px;
            height: 90px;
            background: url('/img/rick-approved.png') no-repeat center center/contain;
            z-index: 5;
            animation: approvedPop 0.7s cubic-bezier(.68,-0.55,.27,1.55);
        }
        @@keyframes approvedPop {
            0% { transform: scale(0.2) rotate(-30deg); opacity: 0; }
            80% { transform: scale(1.1) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .signature-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 2.5rem;
            gap: 2rem;
        }
        .signature-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }
        .signature-area p {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            color: #0ff;
            margin: 0;
            text-shadow: 0 0 8px #0ff;
        }
        #firmaCanvas {
            border: 2px dashed #00ff00;
            background: #111;
            border-radius: 8px;
            cursor: crosshair;
            box-shadow: 0 0 15px #00ff00cc;
            width: 320px;
            height: 100px;
        }
        .instructor-sign {
            width: 320px;
            height: 100px;
            border: 2px dashed #00ff00;
            border-radius: 8px;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0ff;
            font-style: italic;
            box-shadow: 0 0 15px #00ff00cc;
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 2.5rem;
        }
        .controls button {
            font-family: 'Orbitron', monospace;
            padding: 0.8rem 1.7rem;
            font-size: 1.1rem;
            background: #000;
            color: #00ff00;
            border: 2px solid #00ff00;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 0 15px #00ff00cc;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .controls button:hover {
            background: #00ff00;
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 0 25px #00ff00, 0 0 40px #0ff;
        }
        .controls button:active {
            transform: translateY(0);
        }
        @@media (max-width: 1200px) {
            #certificado { width: 98vw; padding: 1rem; }
            .main-content { flex-direction: column; gap: 1.2rem; }
            .avatar-block { flex-direction: row; justify-content: flex-start; }
            .qr-block { margin-top: 0.5rem; }
            .signature-section { flex-direction: column; gap: 1.2rem; }
        }
        @@media print {
            body { background: white; }
            #overlayIntro, .controls, #camaraPreview { display: none !important; }
            #certificado { 
                box-shadow: none !important;
                margin: 0 !important;
            }
        }
        /* Estilos para los nuevos elementos */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .achievement-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.8rem;
            background: rgba(0,255,0,0.1);
            border: 2px solid #00ff00;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
        }
        
        .achievement-badge.unlocked {
            opacity: 1;
            background: rgba(0,255,0,0.2);
            box-shadow: 0 0 15px #00ff00;
        }
        
        .achievement-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #00ff00;
        }
        
        .badge-icon {
            font-size: 1.5rem;
            margin-bottom: 0.3rem;
        }
        
        .badge-text {
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            color: #0ff;
        }
        
        .skills-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .skill-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .skill-checkbox:hover {
            background: rgba(0,255,0,0.1);
        }
        
        .skill-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
            accent-color: #00ff00;
        }
        
        .rating-stars {
            display: flex;
            gap: 0.3rem;
            margin-top: 0.5rem;
        }
        
        .star {
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.3;
        }
        
        .star:hover,
        .star.active {
            opacity: 1;
            transform: scale(1.2);
            filter: drop-shadow(0 0 8px #00ff00);
        }
        
        .star.rated {
            opacity: 1;
            color: #00ff00;
        }
        
        /* Estilos para la secci√≥n de estad√≠sticas */
        .stats-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(0,255,0,0.05);
            border: 2px solid #00ff00;
            border-radius: 12px;
            box-shadow: 0 0 20px #00ff00cc;
        }
        
        .stats-title {
            text-align: center;
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            color: #0ff;
            margin: 0 0 1.5rem 0;
            text-shadow: 0 0 10px #0ff;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.2rem;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid #00ff00;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px #00ff00;
            background: rgba(0,255,0,0.1);
        }
        
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            color: #0ff;
            text-align: center;
            margin-bottom: 0.3rem;
            opacity: 0.8;
        }
        
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #00ff00;
            text-shadow: 0 0 8px #00ff00;
        }
        
        @@media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
<canvas class="matrix-bg"></canvas>
<div class="scanlines"></div>
<div id="overlayIntro">
    <div style="font-size: 2rem; margin-bottom: 1rem; text-shadow: 0 0 20px #00ff00;">üéì CERTIFICADO DE REALIDAD SUPERADA üéì</div>
    <div style="font-size: 1.2rem; margin-bottom: 2rem; color: #0ff;">Has hackeado exitosamente el sistema MVC-137</div>
    <div style="font-size: 1rem; margin-bottom: 2rem; color: #ccc;">Completa tu informaci√≥n y crea tu certificado hacker</div>
    <button onclick="iniciarCertificado()" style="font-size: 1.3rem; background: #00ff00; color: #000; padding: 1rem 2rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px #00ff00;">üéñÔ∏è CREAR MI CERTIFICADO</button>
</div>
<video id="camaraPreview" autoplay style="display:none;"></video>
<audio id="balatroTheme" src="/img/balatrotheme.mp3" autoplay loop style="display:none;"></audio>
<div id="certificado" style="display: none;">
    <div class="header">
        <h1>CERTIFICADO DE REALIDAD SUPERADA</h1>
        <div class="subtitulo">Este documento certifica oficialmente que has hackeado exitosamente el sistema MVC-137</div>
        <div class="date-field">Emitido el: <span id="fechaEmision"></span></div>
        <div class="info-message">
            <span style="color: #0ff; font-size: 0.9rem;">üìä Los datos de desempe√±o se generan autom√°ticamente seg√∫n tu progreso real en el escape room</span>
        </div>
    </div>
    <div class="main-content">
        <div class="avatar-block" style="position:relative;">
            <img id="fotoPreview" src="/img/morty-icon.png" alt="Foto del jugador" title="¬°Haz click en Tomar Foto!" style="width: 190px; height: 190px;" />
            <button class="photo-btn" onclick="sacarFoto()">üì∏ ¬°TOMAR FOTO!</button>
            <label class="photo-btn" style="margin-top:0.5rem;cursor:pointer;">
                üìÇ SUBIR FOTO
                <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="subirFoto(event)" />
            </label>
            <div class="avatar-tooltip">¬°Morty nunca estuvo tan orgulloso!</div>
            <div class="qr-block">
                <canvas id="qr-canvas" width="140" height="140"></canvas>
                <div style="font-size:0.8rem;color:#0ff;opacity:0.7;">¬°Escanea para una sorpresa!</div>
                <div style="font-size:0.7rem;color:#f0f;opacity:0.6;margin-top:0.2rem;">üéµ Never gonna give you up... üéµ</div>
            </div>
        </div>
        <div class="data-block">
            <div class="data-row">
                <div class="info-group">
                    <label>NOMBRE COMPLETO *</label>
                    <input type="text" id="nombreJugador" placeholder="Tu nombre completo" oninput="actualizarNombre();updateQR();" required />
                </div>
                <div class="info-group">
                    <label>CURSO/ESPECIALIDAD *</label>
                    <input type="text" id="cursoJugador" placeholder="Ej: 3ID - Programaci√≥n Web" oninput="updateQR();" required />
                </div>
            </div>
            <div class="data-row">
                <div class="info-group">
                    <label>UNIVERSIDAD/INSTITUCI√ìN *</label>
                    <input type="text" id="institucionJugador" placeholder="Ej: ORT Yatay" oninput="updateQR();" required />
                </div>
                <div class="info-group">
                    <label>CALIFICACI√ìN</label>
                    <select id="calificacionJugador" onchange="actualizarCalificacion();updateQR();" disabled>
                        <option value="A+">A+ (Excelente)</option>
                        <option value="A">A (Muy Bueno)</option>
                        <option value="B+">B+ (Bueno)</option>
                        <option value="B">B (Satisfactorio)</option>
                        <option value="C">C (Aprobado)</option>
                    </select>
                </div>
            </div>
            <div class="data-row">
                <div class="info-group" style="flex:2;">
                    <label>COMENTARIOS DEL INSTRUCTOR</label>
                    <textarea id="comentariosJugador" placeholder="Comentarios sobre el desempe√±o..." oninput="updateQR();"></textarea>
                </div>
                <div class="info-group">
                    <label>FECHA DE COMPLETADO</label>
                    <input type="date" id="fechaCompletado" oninput="updateQR();" />
                </div>
            </div>
            
            <!-- NUEVOS CAMPOS A√ëADIDOS -->
            <div class="data-row">
                <div class="info-group">
                    <label>TIEMPO DE COMPLETADO</label>
                    <input type="text" id="tiempoCompletado" placeholder="Ej: 45 minutos" oninput="updateQR();" />
                </div>
                <div class="info-group">
                    <label>NIVEL DE DIFICULTAD</label>
                    <select id="nivelDificultad" onchange="updateQR();">
                        <option value="F√°cil">F√°cil</option>
                        <option value="Intermedio" selected>Intermedio</option>
                        <option value="Dif√≠cil">Dif√≠cil</option>
                        <option value="Experto">Experto</option>
                    </select>
                </div>
                <div class="info-group">
                    <label>PUNTUACI√ìN FINAL</label>
                    <input type="number" id="puntuacionFinal" placeholder="Ej: 850" min="0" max="1000" oninput="updateQR();" />
                </div>
            </div>
            
            <div class="data-row">
                <div class="info-group">
                    <label>EMAIL</label>
                    <input type="email" id="emailJugador" placeholder="tu@email.com" oninput="updateQR();" />
                </div>
                <div class="info-group">
                    <label>EDAD</label>
                    <input type="number" id="edadJugador" placeholder="Ej: 25" min="1" max="120" oninput="updateQR();" />
                </div>
                <div class="info-group">
                    <label>PA√çS</label>
                    <input type="text" id="paisJugador" placeholder="Ej: Argentina" oninput="updateQR();" />
                </div>
            </div>
            
            <div class="data-row">
                <div class="info-group" style="flex:2;">
                    <label>LOGROS DESBLOQUEADOS</label>
                    <div class="achievements-grid" id="achievementsGrid">
                        <!-- Las postales de las rooms superadas se insertar√°n aqu√≠ por JS -->
                    </div>
                </div>
                <div class="info-group">
                    <label>N√öMERO DE INTENTOS</label>
                    <input type="number" id="numeroIntentos" placeholder="Ej: 3" min="1" oninput="updateQR();" />
                </div>
            </div>
            
            <div class="data-row">
                <div class="info-group" style="flex:2;">
                    <label>HABILIDADES DEMOSTRADAS</label>
                    <div class="skills-container">
                        <label class="skill-checkbox">
                            <input type="checkbox" value="L√≥gica" onchange="updateQR();"> L√≥gica
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Programaci√≥n" onchange="updateQR();"> Programaci√≥n
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Criptograf√≠a" onchange="updateQR();"> Criptograf√≠a
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="An√°lisis" onchange="updateQR();"> An√°lisis
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Creatividad" onchange="updateQR();"> Creatividad
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Paciencia" onchange="updateQR();"> Paciencia
                        </label>
                    </div>
                </div>
                <div class="info-group">
                    <label>NIVEL DE SATISFACCI√ìN</label>
                    <div class="rating-stars">
                        <span class="star" data-rating="1">‚≠ê</span>
                        <span class="star" data-rating="2">‚≠ê</span>
                        <span class="star" data-rating="3">‚≠ê</span>
                        <span class="star" data-rating="4">‚≠ê</span>
                        <span class="star" data-rating="5">‚≠ê</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="calificacion-block">
        <div class="calificacion-label">Calificaci√≥n Final:</div>
        <span class="grade-display" id="gradeDisplay">A+<span class="rick-approved" id="rickApproved"></span></span>
    </div>
    
    <!-- NUEVA SECCI√ìN DE ESTAD√çSTICAS -->
    <div class="stats-section">
        <h3 class="stats-title">üìä ESTAD√çSTICAS DE COMPLETADO</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-label">Tiempo Promedio</div>
                <div class="stat-value" id="tiempoPromedio">45 min</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üéØ</div>
                <div class="stat-label">Precisi√≥n</div>
                <div class="stat-value" id="precision">92%</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üöÄ</div>
                <div class="stat-label">Velocidad</div>
                <div class="stat-value" id="velocidad">R√°pido</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üß©</div>
                <div class="stat-label">Puzzles Resueltos</div>
                <div class="stat-value" id="puzzlesResueltos">8/8</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üîç</div>
                <div class="stat-label">Pistas Usadas</div>
                <div class="stat-value" id="pistasUsadas">2</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-label">Ranking Global</div>
                <div class="stat-value" id="rankingGlobal">#127</div>
            </div>
        </div>
    </div>
    <div class="signature-section">
        <div class="signature-area">
            <p>Firma</p>
            <canvas id="firmaCanvas" width="320" height="100"></canvas>
            <button onclick="borrarFirma()" style="font-size: 0.9rem; padding: 0.5rem 1rem;">Borrar Firma</button>
        </div>
        <div class="signature-area">
            <p>Firma del Instructor</p>
            <div class="instructor-sign">
                Rick S√°nchez, PhD
            </div>
        </div>
    </div>
    <div class="controls">
        <button onclick="abrirPersonalizacion()" style="background: #0ff; color: #000;">üé® Personalizar certificado</button>
        <button onclick="descargarCertificado()">üíæ Descargar PNG</button>
        <button onclick="descargarPDF()">üìÑ Descargar PDF</button>
        <button onclick="imprimirCertificado()">üñ®Ô∏è Imprimir</button>
    </div>
</div>

<!-- Modal de personalizaci√≥n -->
<div id="modalPersonalizacion" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#111; border-radius:16px; padding:2rem 2.5rem; box-shadow:0 0 30px #0ff, 0 0 60px #00ff00; min-width:320px; max-width:90vw;">
        <h2 style="color:#0ff; text-align:center; margin-bottom:1.5rem;">Personaliza tu certificado</h2>
        <div style="display:flex; flex-direction:column; gap:1.2rem;">
            <label style="color:#0ff;">Color principal (bordes, t√≠tulos): <input type="color" id="colorPrimario" value="#00ff00" style="margin-left:1rem;"></label>
            <label style="color:#0ff;">Color secundario (textos, detalles): <input type="color" id="colorSecundario" value="#0ff" style="margin-left:1rem;"></label>
            <label style="color:#0ff;">Imagen de fondo (opcional): <input type="file" id="fondoCertificado" accept="image/*" style="margin-left:1rem;"></label>
        </div>
        <div style="display:flex; gap:1.5rem; justify-content:center; margin-top:2rem;">
            <button onclick="previsualizarPersonalizacion()" style="background:#0ff; color:#000; padding:0.7rem 1.5rem; border-radius:8px; font-weight:bold;">Previsualizar</button>
            <button onclick="cerrarPersonalizacion()" style="background:#f0f; color:#fff; padding:0.7rem 1.5rem; border-radius:8px; font-weight:bold;">Cancelar</button>
            <button onclick="aplicarYDescargar()" style="background:#00ff00; color:#000; padding:0.7rem 1.5rem; border-radius:8px; font-weight:bold;">Descargar</button>
        </div>
    </div>
</div>

<script>
// Matrix background effect
const canvas = document.querySelector('.matrix-bg');
const ctx = canvas.getContext('2d');
let w = window.innerWidth, h = window.innerHeight;
canvas.width = w; canvas.height = h;
let cols = Math.floor(w / 18);
let ypos = Array(cols).fill(0);
function matrix() {
    ctx.fillStyle = 'rgba(0,0,0,0.08)';
    ctx.fillRect(0, 0, w, h);
    ctx.font = '18px Fira Code, monospace';
    ctx.fillStyle = '#00ff00';
    for (let i = 0; i < cols; i++) {
        let text = String.fromCharCode(0x30A0 + Math.random() * 96);
        ctx.fillText(text, i * 18, ypos[i] * 18);
        if (Math.random() > 0.975) ypos[i] = 0;
        else ypos[i]++;
    }
    requestAnimationFrame(matrix);
}
matrix();
window.addEventListener('resize', () => {
    w = window.innerWidth; h = window.innerHeight;
    canvas.width = w; canvas.height = h;
    cols = Math.floor(w / 18);
    ypos = Array(cols).fill(0);
});
// Fecha actual
const fecha = new Date();
document.getElementById('fechaEmision').textContent = fecha.toLocaleDateString('es-ES', {
    year: 'numeric', month: 'long', day: 'numeric'
});
document.getElementById('fechaCompletado').value = fecha.toISOString().split('T')[0];
// Firma
const firmaCanvas = document.getElementById("firmaCanvas");
const firmaCtx = firmaCanvas.getContext("2d");
let dibujando = false, lastX, lastY;
firmaCanvas.addEventListener("mousedown", (e) => {
    dibujando = true;
    const rect = firmaCanvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
    lastY = e.clientY - rect.top;
});
firmaCanvas.addEventListener("mouseup", () => dibujando = false);
firmaCanvas.addEventListener("mouseout", () => dibujando = false);
firmaCanvas.addEventListener("mousemove", (e) => {
        if (!dibujando) return;
    const rect = firmaCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    firmaCtx.lineWidth = 3;
    firmaCtx.lineCap = "round";
    firmaCtx.strokeStyle = "#00ff00";
    firmaCtx.shadowColor = "#00ff00";
    firmaCtx.shadowBlur = 10;
    firmaCtx.beginPath();
    firmaCtx.moveTo(lastX, lastY);
    firmaCtx.lineTo(x, y);
    firmaCtx.stroke();
    lastX = x; lastY = y;
});
    function borrarFirma() {
    firmaCtx.clearRect(0, 0, firmaCanvas.width, firmaCanvas.height);
    }
// Nombre y calificaci√≥n
function actualizarNombre() {
    const nombre = document.getElementById('nombreJugador').value || '[Tu Nombre]';
    document.getElementById('nombreDisplay').textContent = nombre;
}
function actualizarCalificacion() {
    const calificacion = document.getElementById('calificacionJugador').value;
    document.getElementById('gradeDisplay').textContent = calificacion;
    // Rick Approved sticker
    const sticker = document.getElementById('rickApproved');
    if (calificacion === 'A+' || calificacion === 'A') {
        sticker.style.display = 'block';
    } else {
        sticker.style.display = 'none';
    }
}
// QR code
function updateQR() {
    const nombre = document.getElementById('nombreJugador').value;
    const curso = document.getElementById('cursoJugador').value;
    const inst = document.getElementById('institucionJugador').value;
    const calif = document.getElementById('calificacionJugador').value;
    const fecha = document.getElementById('fechaCompletado').value;
    const tiempo = document.getElementById('tiempoCompletado').value;
    const dificultad = document.getElementById('nivelDificultad').value;
    const puntuacion = document.getElementById('puntuacionFinal').value;
    const email = document.getElementById('emailJugador').value;
    const edad = document.getElementById('edadJugador').value;
    const pais = document.getElementById('paisJugador').value;
    const intentos = document.getElementById('numeroIntentos').value;
    const logros = getUnlockedAchievements();
    const habilidades = getSelectedSkills();
    
    // QR siempre apunta al Rick Roll cl√°sico
    const qr = new QRious({
        element: document.getElementById('qr-canvas'),
        value: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
        size: 140,
        background: '#fff',
        foreground: '#000',
        level: 'H'
    });
}
setTimeout(updateQR, 500);
    // C√°mara
    const cam = document.getElementById("camaraPreview");
    const preview = document.getElementById("fotoPreview");
    if (navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 } } })
        .then(stream => { cam.srcObject = stream; })
        .catch(err => { console.log('C√°mara no disponible:', err); });
}
function sacarFoto() {
            cam.style.display = 'block';
    setTimeout(() => {
        if (cam.videoWidth === 0) {
            alert('La c√°mara no est√° lista. Espera un momento y vuelve a intentar.');
            cam.style.display = 'none';
            return;
        }
        // Efecto flash
        const flash = document.createElement('div');
        flash.style.cssText = `position: fixed;top:0;left:0;width:100vw;height:100vh;background:white;opacity:0;z-index:10000;animation:flashAnim 0.3s ease-in-out;`;
        document.body.appendChild(flash);
        setTimeout(() => {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = cam.videoWidth;
            tempCanvas.height = cam.videoHeight;
            const ctx = tempCanvas.getContext('2d');
            ctx.drawImage(cam, 0, 0);
            // Circular
            const circularCanvas = document.createElement('canvas');
            circularCanvas.width = 120;
            circularCanvas.height = 120;
            const circularCtx = circularCanvas.getContext('2d');
            circularCtx.beginPath();
            circularCtx.arc(60, 60, 58, 0, 2 * Math.PI);
            circularCtx.clip();
            circularCtx.drawImage(tempCanvas, 0, 0, 120, 120);
            preview.src = circularCanvas.toDataURL('image/png');
            flash.remove();
            cam.style.display = 'none';
        }, 150);
    }, 200);
}
function subirFoto(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
        const img = new window.Image();
        img.onload = function() {
            // Recorte circular y resize
            const circularCanvas = document.createElement('canvas');
            circularCanvas.width = 190;
            circularCanvas.height = 190;
            const ctx = circularCanvas.getContext('2d');
            ctx.beginPath();
            ctx.arc(95, 95, 93, 0, 2 * Math.PI);
            ctx.clip();
            // Ajustar para que la imagen llene el c√≠rculo
            let sx = 0, sy = 0, sw = img.width, sh = img.height;
            if (img.width > img.height) {
                sx = (img.width - img.height) / 2;
                sw = sh = img.height;
            } else if (img.height > img.width) {
                sy = (img.height - img.width) / 2;
                sw = sh = img.width;
            }
            ctx.drawImage(img, sx, sy, sw, sh, 0, 0, 190, 190);
            document.getElementById('fotoPreview').src = circularCanvas.toDataURL('image/png');
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
}
function setDownloadMode(enable, colorPrimario, colorSecundario, fondoDataUrl) {
    const cert = document.getElementById('certificado');
    const foto = document.getElementById('fotoPreview');
    const qr = document.getElementById('qr-canvas');
    const header = cert.querySelector('.header h1');
    const subtitle = cert.querySelector('.header .subtitulo');
    const photoButtons = cert.querySelectorAll('.photo-btn');
    const signatureButton = cert.querySelector('button[onclick="borrarFirma()"]');
    const navMenu = document.getElementById('hackerNav');
    const autoHideFields = document.querySelectorAll('.auto-hide');

    if (enable) {
        // Si hay personalizaci√≥n, usarla
        if (colorPrimario && colorSecundario) {
            cert.style.background = '#fff';
            cert.style.border = `4px solid ${colorPrimario}`;
            cert.style.boxShadow = `0 0 40px ${colorPrimario}, 0 0 60px ${colorSecundario}`;
            cert.style.color = colorSecundario;
            cert.querySelectorAll('.header h1, .calificacion-label, .stats-title').forEach(el => {
                el.style.color = colorPrimario;
                el.style.textShadow = `0 0 18px ${colorPrimario}, 0 0 32px ${colorSecundario}`;
            });
            cert.querySelectorAll('label').forEach(el => { el.style.color = colorSecundario; });
            cert.querySelectorAll('.grade-display').forEach(el => { el.style.color = colorPrimario; });
            if (fondoDataUrl) {
                cert.style.backgroundImage = `url('${fondoDataUrl}')`;
                cert.style.backgroundSize = 'cover';
                cert.style.backgroundPosition = 'center';
                cert.style.backgroundRepeat = 'no-repeat';
            } else {
                cert.style.backgroundImage = '';
            }
            // QR personalizado
            new QRious({
                element: qr,
                value: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
                size: 140,
                background: '#fff',
                foreground: colorPrimario,
                level: 'H'
            });
        } else {
            // Modo blanco/dorado por defecto
            cert.style.background = '#fff';
            cert.style.border = '6px solid #d4af37';
            cert.style.boxShadow = '0 0 40px #d4af37, 0 0 60px #fff inset';
            cert.style.color = '#222';
            header.style.color = '#d4af37';
            header.style.textShadow = '0 0 8px #d4af37, 0 0 12px #fff';
            subtitle.style.color = '#555';
            foto.style.boxShadow = '0 0 24px #d4af37, 0 0 40px #fff';
            qr.style.background = '#fff';
            qr.style.boxShadow = '0 0 12px #d4af37';
            cert.querySelectorAll('input, textarea, select, .grade-display, .instructor-sign, .signature-area p, .calificacion-label').forEach(el => {
                el.style.color = '#222';
                el.style.borderColor = '#d4af37';
                el.style.background = '#fff';
                el.style.boxShadow = '0 0 8px #d4af37';
            });
            cert.querySelectorAll('label').forEach(el => { el.style.color = '#d4af37'; });
            new QRious({
                element: qr,
                value: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
                size: 140,
                background: '#fff',
                foreground: '#d4af37',
                level: 'H'
            });
        }
        // Ocultar botones y men√∫
        photoButtons.forEach(btn => btn.style.display = 'none');
        if (signatureButton) signatureButton.style.display = 'none';
        if (navMenu) navMenu.style.display = 'none';
        // Ocultar campos auto-hide si est√°n vac√≠os, en N/A o valor por defecto
        autoHideFields.forEach(field => {
            if (!field.value || field.value === 'N/A' || field.value === '' || field.value === '0' || field.value === 'F√°cil') {
                field.parentElement.style.display = 'none';
            }
        });
    } else {
        // Restaurar
        cert.style.background = '';
        cert.style.border = '';
        cert.style.boxShadow = '';
        cert.style.color = '';
        cert.style.backgroundImage = '';
        header.style.color = '';
        header.style.textShadow = '';
        subtitle.style.color = '';
        foto.style.boxShadow = '';
        qr.style.background = '';
        qr.style.boxShadow = '';
        photoButtons.forEach(btn => btn.style.display = '');
        if (signatureButton) signatureButton.style.display = '';
        if (navMenu) navMenu.style.display = '';
        cert.querySelectorAll('input, textarea, select, .grade-display, .instructor-sign, .signature-area p, .calificacion-label').forEach(el => {
            el.style.color = '';
            el.style.borderColor = '';
            el.style.background = '';
            el.style.boxShadow = '';
        });
        cert.querySelectorAll('label').forEach(el => { el.style.color = ''; });
        new QRious({
            element: qr,
            value: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
            size: 140,
            background: '#fff',
            foreground: '#000',
            level: 'H'
        });
        autoHideFields.forEach(field => {
            field.parentElement.style.display = '';
        });
    }
}
function descargarCertificado(colorPrimario, colorSecundario, fondoDataUrl) {
    const nombre = document.getElementById('nombreJugador').value.trim();
    const curso = document.getElementById('cursoJugador').value.trim();
    const institucion = document.getElementById('institucionJugador').value.trim();
    if (!nombre || !curso || !institucion) {
        alert('Por favor completa todos los campos requeridos (*) antes de descargar el certificado.');
        return;
    }
    const certificado = document.getElementById('certificado');
    const controls = document.querySelector('.controls');
    controls.style.display = 'none';
    setDownloadMode(true, colorPrimario, colorSecundario, fondoDataUrl);
    html2canvas(certificado, {
        useCORS: true,
        scale: 4,
        backgroundColor: '#fff',
        width: certificado.offsetWidth,
        height: certificado.offsetHeight,
        logging: false
    }).then(canvas => {
        setDownloadMode(false);
        const link = document.createElement('a');
        link.download = `Certificado_${nombre.replaceAll(' ', '_')}_${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
        controls.style.display = 'flex';
    });
}
function descargarPDF() {
    const nombre = document.getElementById('nombreJugador').value.trim();
    const curso = document.getElementById('cursoJugador').value.trim();
    const institucion = document.getElementById('institucionJugador').value.trim();
    
    if (!nombre || !curso || !institucion) {
        alert('Por favor completa todos los campos requeridos (*) antes de descargar el certificado.');
        return;
    }
    
    const certificado = document.getElementById('certificado');
    const controls = document.querySelector('.controls');
    controls.style.display = 'none';
    setDownloadMode(true);
    html2canvas(certificado, {
        useCORS: true,
        scale: 2,
        backgroundColor: '#fff',
        width: certificado.offsetWidth,
        height: certificado.offsetHeight
    }).then(canvas => {
        setDownloadMode(false);
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('landscape', 'mm', 'a4');
        const imgWidth = 297;
        const pageHeight = 210;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        pdf.save(`Certificado_${nombre.replaceAll(' ', '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        controls.style.display = 'flex';
    });
}
function imprimirCertificado() {
    window.print();
}
function iniciarCertificado() {
    document.getElementById('overlayIntro').style.display = 'none';
    document.getElementById('certificado').style.display = 'block';
    
    // Cargar datos reales autom√°ticamente
    setTimeout(() => {
        cargarDatosReales();
    }, 500);
    
    setTimeout(() => {
        document.getElementById('certificado').style.animation = 'none';
    }, 1500);
}
// Animaci√≥n flash
const style = document.createElement('style');
style.textContent = `@@keyframes flashAnim {0%{opacity:0;}50%{opacity:0.8;}100%{opacity:0;}}`;
document.head.appendChild(style);

// Funciones para los nuevos elementos
let currentRating = 0;

// Manejo de logros
document.querySelectorAll('.achievement-badge').forEach(badge => {
    badge.addEventListener('click', function() {
        this.classList.toggle('unlocked');
        updateQR();
    });
});

// Manejo de estrellas de rating
document.querySelectorAll('.star').forEach(star => {
    star.addEventListener('click', function() {
        const rating = parseInt(this.getAttribute('data-rating'));
        currentRating = rating;
        
        // Actualizar visualizaci√≥n
        document.querySelectorAll('.star').forEach((s, index) => {
            if (index < rating) {
                s.classList.add('rated');
            } else {
                s.classList.remove('rated');
            }
        });
        
        updateQR();
    });
    
    star.addEventListener('mouseenter', function() {
        const rating = parseInt(this.getAttribute('data-rating'));
        document.querySelectorAll('.star').forEach((s, index) => {
            if (index < rating) {
                s.classList.add('active');
            } else {
                s.classList.remove('active');
            }
        });
    });
    
    star.addEventListener('mouseleave', function() {
        document.querySelectorAll('.star').forEach(s => {
            s.classList.remove('active');
        });
    });
});

// Funci√≥n para obtener logros desbloqueados
function getUnlockedAchievements() {
    const unlocked = [];
    document.querySelectorAll('.achievement-badge.unlocked').forEach(badge => {
        unlocked.push(badge.getAttribute('data-achievement'));
    });
    return unlocked.join(', ');
}

// Funci√≥n para obtener habilidades seleccionadas
function getSelectedSkills() {
    const skills = [];
    document.querySelectorAll('.skill-checkbox input:checked').forEach(checkbox => {
        skills.push(checkbox.value);
    });
    return skills.join(', ');
}

// Descripciones de rooms para el certificado
const roomDescriptions = [
    '',
    'Room 1: Primeros pasos en el sistema. ¬°Bienvenido al desaf√≠o!',
    'Room 2: L√≥gica y observaci√≥n. Has descifrado el primer c√≥digo.',
    'Room 3: ADN y an√°lisis. Superaste el reto biotecnol√≥gico.',
    'Room 4: Programaci√≥n y secuencias. Dominaste la consola.',
    'Room 5: Creatividad y deducci√≥n. Resolviste el enigma visual.',
    'Room 6: Criptograf√≠a avanzada. Descifraste los secretos de Rick.',
    'Room 7: Balatro Codex. Lograste el desaf√≠o m√°s complejo.',
    'Room 8: Escape final. Superaste la √∫ltima barrera.',
    'Room 9: Realidad superada. ¬°Completaste el escape room!'
];

function poblarLogrosRooms(completedRooms) {
    const grid = document.getElementById('achievementsGrid');
    grid.innerHTML = '';
    console.log('Rooms completadas:', completedRooms);
    if (!completedRooms || completedRooms.length === 0) {
        grid.innerHTML = '<div style="color:#0ff; opacity:0.7; text-align:center;">No has completado ninguna sala a√∫n.</div>';
        return;
    }
    completedRooms.forEach(num => {
        if (num >= 1 && num <= 9) {
            const div = document.createElement('div');
            div.className = 'room-postal';
            div.innerHTML = `
                <img src="/img/postal${num}.png" alt="Room ${num}" class="postal-img" style="width:100px; border-radius:8px; box-shadow:0 0 10px #0ff; margin-bottom:0.3rem;">
                <div class="postal-title" style="font-size:0.95rem; color:#0ff; font-weight:bold; text-align:center;">Room ${num}</div>
                <div class="postal-desc" style="font-size:0.75rem; color:#fff; opacity:0.7; text-align:center;">${roomDescriptions[num]}</div>
            `;
            grid.appendChild(div);
        }
    });
}

// Cargar datos reales del jugador
function cargarDatosReales() {
    fetch('/Home/GetCertificateData', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Llenar campos autom√°ticamente
        document.getElementById('tiempoCompletado').value = (data.completedRooms.length === 9) ? data.estimatedTime : 'N/A';
        document.getElementById('nivelDificultad').value = data.difficultyLevel || 'N/A';
        document.getElementById('puntuacionFinal').value = data.score || 'N/A';
        document.getElementById('calificacionJugador').value = data.grade;
        document.getElementById('numeroIntentos').value = Math.max(1, data.completedRooms.length);

        // Comentario detallado y personalizado
        let comment = '';
        if (data.completedRooms.length === 9) {
            comment += '¬°Incre√≠ble! Has completado todas las salas del escape room, demostrando perseverancia, l√≥gica y creatividad. ';
            if (data.grade === 'A+' || data.grade === 'A') comment += 'Tu desempe√±o fue sobresaliente, resolviendo los desaf√≠os m√°s complejos con gran destreza. ';
            if (data.specificAchievements && data.specificAchievements.includes('genius')) comment += 'Obtuviste el logro "Genius", lo que te coloca entre los mejores jugadores. ';
            comment += 'Tu tiempo de completado fue de ' + data.estimatedTime + ', lo que indica una excelente gesti√≥n del tiempo.';
        } else if (data.completedRooms.length >= 6) {
            comment += 'Has avanzado por la mayor√≠a de las salas, mostrando buenas habilidades de resoluci√≥n de problemas. ';
            if (data.grade === 'B+' || data.grade === 'B') comment += 'Tu progreso es s√≥lido, aunque podr√≠as mejorar en algunos retos avanzados. ';
            comment += 'Sigue practicando para alcanzar la perfecci√≥n.';
        } else if (data.completedRooms.length >= 3) {
            comment += 'Buen comienzo. Has superado varios desaf√≠os iniciales y tienes potencial para avanzar mucho m√°s. ';
            if (data.grade === 'C+' || data.grade === 'C') comment += 'Te recomiendo repasar los conceptos de l√≥gica y an√°lisis para mejorar tu rendimiento.';
        } else {
            comment += 'Est√°s dando tus primeros pasos en el escape room. Cada sala completada suma experiencia. ¬°No te rindas!';
        }
        document.getElementById('comentariosJugador').value = comment;

        // Actualizar estad√≠sticas
        if (data.stats) {
            document.getElementById('tiempoPromedio').textContent = data.stats.tiempoPromedio;
            document.getElementById('precision').textContent = data.stats.precision;
            document.getElementById('velocidad').textContent = data.stats.velocidad;
            document.getElementById('puzzlesResueltos').textContent = data.stats.puzzlesResueltos;
            document.getElementById('pistasUsadas').textContent = data.stats.pistasUsadas;
            document.getElementById('rankingGlobal').textContent = data.stats.rankingGlobal;
        }
        // Desbloquear logros reales
        if (data.specificAchievements) {
            document.querySelectorAll('.achievement-badge').forEach(badge => {
                const achievementName = badge.getAttribute('data-achievement');
                if (data.specificAchievements.includes(achievementName)) {
                    badge.classList.add('unlocked');
                }
            });
        }
        // Seleccionar habilidades reales
        if (data.skills) {
            document.querySelectorAll('.skill-checkbox input').forEach(checkbox => {
                if (data.skills.includes(checkbox.value)) {
                    checkbox.checked = true;
                }
            });
        }
        // Establecer rating basado en calificaci√≥n
        let rating = 3; // Default
        if (data.grade === 'A+') rating = 5;
        else if (data.grade === 'A') rating = 4;
        else if (data.grade === 'B+') rating = 4;
        else if (data.grade === 'B') rating = 3;
        else if (data.grade === 'C+') rating = 3;
        else if (data.grade === 'C') rating = 2;
        else rating = 1;
        currentRating = rating;
        document.querySelectorAll('.star').forEach((star, index) => {
            if (index < rating) {
                star.classList.add('rated');
            }
        });
        actualizarCalificacion();
        updateQR();

        // Llamar a poblarLogrosRooms
        poblarLogrosRooms(data.completedRooms || []);
    })
    .catch(error => {
        console.error('Error cargando datos del certificado:', error);
    });
}

function abrirPersonalizacion() {
    document.getElementById('modalPersonalizacion').style.display = 'flex';
}
function cerrarPersonalizacion() {
    document.getElementById('modalPersonalizacion').style.display = 'none';
}
// Guardar los estilos originales para restaurar
let estilosOriginales = null;
let fondoOriginal = null;

function previsualizarPersonalizacion() {
    const colorPrimario = document.getElementById('colorPrimario').value;
    const colorSecundario = document.getElementById('colorSecundario').value;
    const fondoInput = document.getElementById('fondoCertificado');
    const cert = document.getElementById('certificado');

    // Guardar estilos originales solo la primera vez
    if (!estilosOriginales) {
        estilosOriginales = {
            border: cert.style.border,
            boxShadow: cert.style.boxShadow,
            color: cert.style.color,
        };
        fondoOriginal = cert.style.backgroundImage;
    }

    // Aplicar colores
    cert.style.border = `4px solid ${colorPrimario}`;
    cert.style.boxShadow = `0 0 40px ${colorPrimario}, 0 0 60px ${colorSecundario}`;
    cert.style.color = colorSecundario;
    cert.querySelectorAll('.header h1, .calificacion-label, .stats-title').forEach(el => {
        el.style.color = colorPrimario;
        el.style.textShadow = `0 0 18px ${colorPrimario}, 0 0 32px ${colorSecundario}`;
    });
    cert.querySelectorAll('label').forEach(el => { el.style.color = colorSecundario; });
    cert.querySelectorAll('.grade-display').forEach(el => { el.style.color = colorPrimario; });

    // Imagen de fondo
    if (fondoInput.files && fondoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            cert.style.backgroundImage = `url('${e.target.result}')`;
            cert.style.backgroundSize = 'cover';
            cert.style.backgroundPosition = 'center';
            cert.style.backgroundRepeat = 'no-repeat';
        };
        reader.readAsDataURL(fondoInput.files[0]);
    } else {
        cert.style.backgroundImage = '';
    }
}

function aplicarYDescargar() {
    const colorPrimario = document.getElementById('colorPrimario').value;
    const colorSecundario = document.getElementById('colorSecundario').value;
    const fondoInput = document.getElementById('fondoCertificado');
    if (fondoInput.files && fondoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            cerrarPersonalizacion();
            setTimeout(() => {
                descargarCertificado(colorPrimario, colorSecundario, e.target.result);
            }, 300);
        };
        reader.readAsDataURL(fondoInput.files[0]);
    } else {
        cerrarPersonalizacion();
        setTimeout(() => {
            descargarCertificado(colorPrimario, colorSecundario, null);
        }, 300);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    var audio = document.getElementById('balatroTheme');
    if (audio) {
        audio.volume = 0.3;
        audio.play().catch(()=>{});
    }
});
</script>
    @Html.Partial("_NavMenu")
</body>
</html>